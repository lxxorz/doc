# 透视投影矩阵的推导

-- 李鑫鑫
## 什么是透视投影
透视投影是一种模拟人眼的投影方式，在平行投影中，两条直线永远不会相交，但是在透视投影中，物体呈现出近大远小的状态，两条平行的直线最终是会相交的，就像图中的两条铁轨一样

![](perspective_example.jpeg)

[![](perspective-frstum.jpeg)
透视投影有点类似小孔成像的原理，同样大小的物体，在远处的物体投影到平面上会更小。实现透视投影变换也需要定义一个视锥体（viewing frstum）。通常用一个四元组表示 $(fov, aspectRatio,n, f)$，要推导透视投影变换，可以先将透视投影变换转换成正交投影变换。因为透视投影变换和正交投影变换的区别仅在于 viewing frstum 不同，最终都是讲 viewing frstum 移动到原点并归一化。所以第一步就是将 frstum 变成长方体，之后的操作就和正交投影变换一模一样

##  将透视投影 frstum“压缩”成正交投影 frstum

![](perspective-2D.jpeg)
假设从 frstum 的变换矩阵是
$$
A=\begin{pmatrix}
a & b & c & d \\
e & f & g & h \\
i & j & k & l \\
o & p & q & r
\end{pmatrix}
$$

取远平面上的点 $(x,y,z)$ ，经过挤压之后，其坐标是 $(x',y',z')$，

![](%E5%8F%AF%E8%A7%86%E5%8C%96/%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES-101/assets/507fdbf3b1724866203d5a33e2ee50fb_MD5.jpeg)

由上图可知
$$
\frac{y'}{y}=\frac{n}{z}
$$
所以 $y'=\frac{n}{z}y$，同理 $x'=\frac{n}{z}x$ 
$$
A\begin{pmatrix}
x \\
y \\
f \\
1
\end{pmatrix}
=
\begin{pmatrix}
\frac{n}{z}x \\
\frac{n}{z}y \\
f \\
1
\end{pmatrix}
$$

发现经过变换之后 $x'$ 以及 $y'$ 和 $z$ 有了关系，不过由于在齐次坐标下，点的坐标表示不止一种, 因此对正交投影的 viewing frstum 的压缩，最终转换过后的坐标也可以是如下表示
$$
A
\begin{pmatrix}
x \\
y \\
z \\
1
\end{pmatrix}
=
\begin{pmatrix}
x'\cdot z \\
y'\cdot z \\
unknown\cdot z \\
z
\end{pmatrix}
=\begin{pmatrix}
n\cdot x \\
n\cdot y \\
unknown \\
z
\end{pmatrix}
$$

至此，已经求出了变换之后的 x, y 坐标，可以反向求出矩阵的一些参数，先假设变换矩阵是
$$
                                                                        
$$
根据线性变换的齐次性 $T(\vec{v}+\vec{w})=T(\vec{v})+T(\vec{w})$，
$$
A\cdot \vec{v} = A\cdot \begin{pmatrix}
x \\
0 \\
0 \\
0
\end{pmatrix}
+A\cdot \begin{pmatrix}
0 \\
y \\
0 \\
0
\end{pmatrix}
+A\cdot \begin{pmatrix}
0 \\
0 \\
z \\
0
\end{pmatrix}
+A\cdot \begin{pmatrix}
0 \\
0 \\
1 \\
0
\end{pmatrix}
=
\begin{pmatrix}
nx \\
ny \\
unknown \\
z
\end{pmatrix}
$$


$$
\begin{pmatrix}
n & 0 & 0 & 0  \\
0 & n & 0 & 0  \\
0 & 0 & k & l \\
0 & 0 & 1 & 0 
\end{pmatrix}
$$

我们还知道两个条件
1. 远平面上的中心点经过变换之后，坐标不会发生改变

$$
A
\begin{pmatrix}
x \\
y \\
f \\
1
\end{pmatrix}
=
\begin{pmatrix}
x \\
y \\
f \\
1
\end{pmatrix}
=\begin{pmatrix}
xf \\
yf \\
f^2 \\
f
\end{pmatrix}
$$
2. 近平面上的点坐标不会发生改变

$$
A
\begin{pmatrix}
x \\
y \\
n \\
1
\end{pmatrix}
=
\begin{pmatrix}
x \\
y \\
n \\
1
\end{pmatrix}
=\begin{pmatrix}
xn  \\
yn \\
n^2 \\
n
\end{pmatrix}
$$
$$
\begin{aligned}
&kf  + l=f^2 \\
& kn  +l  =n^2
\end{aligned}
$$
解得：$k=n+f$ $l=-nf$，最终将投影投影矩阵转换为正交投影矩阵的变换矩阵结果如下
$$
\begin{pmatrix}
n & 0 & 0 & 0  \\
0 & n & 0 & 0  \\
0 & 0 & n+f & -nf \\
0 & 0 & 1 & 0 
\end{pmatrix}
$$
然后就是进行正交投影，通常来说正交投影的参数是 left right bottom top near far。在透视投影中定义一个 viewing frstum 更普遍的是采用 fov 可视角 aspect-ratio 宽高比以及 near far 四个参数定义
![perspective-frstum](perspective-frstum.jpeg)

$$
\begin{align}
t &=n\cdot\tan{\frac{\alpha}{2}} \\
b &=-t \\
l &=t\cdot ratio \\
r &=-l
\end{align}
$$
![正交投影矩阵的推导](正交投影矩阵的推导.md)
